import Head from 'next/head'
import { useState, useEffect, ChangeEvent } from 'react';
import { login, mint } from '@/services/Web3Service';

export default function Mint() {

  const [quantity, setQuantity] = useState<number>(1);
  const [wallet, setWallet] = useState<string>("");
  const [message, setMessage] = useState<string>("");

  useEffect(() => {
    const wallet = localStorage.getItem("wallet");
    if (wallet)
      setWallet(wallet);
  },[])

  function onQuantityChange(evt: ChangeEvent<HTMLInputElement>) {
    setQuantity(parseInt(evt.target.value));
  }

  function btnMintClick() {
    
    setMessage("Minting...");
    
    mint(quantity)
      .then(tx => {
        setMessage("Tx Id: " + tx || "error")
      })
      .catch(err => setMessage(err.message));    
  }
  
  function btnLoginClick() {
    
    setMessage("Logging in");
    
    login()
      .then(wallet => {
        setWallet(wallet);
        localStorage.setItem("wallet",wallet);
        setMessage("");
      })
      .catch(err => setMessage(err.message));
  }
  
  function btnLogoutClick() {
    setMessage("Logging out");
    localStorage.removeItem("wallet");
    setWallet("");
    alert("Logout!!!");
    setMessage("");
  }

  return (
    <>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main>
        <h1>Mint Page</h1>
        <hr />
        <br />
        {
            wallet
            ? (
              <p>
                <label htmlFor="">
                  Quantity:
                  <input type="number" id="quantity" value={quantity} onChange={onQuantityChange} />
                </label>
                <button id='btnMint' onClick={btnMintClick}>Mint</button>
              </p>
            )
            : <></>
        }
        <p>
          {
            wallet
            ? (
              <>
                <br />
                <a href={`${process.env.OPENSEA_URL}/${wallet}`} target='_blank'>
                  {wallet}
                </a>
                <br />
                <br />
                <button id='btnLogout' onClick={btnLogoutClick}>Logout</button>
              </>
            )
            : (
              <>
                <br />
                <button id='btnLogin' onClick={btnLoginClick} >Login</button>
              </>
            )
          }
        </p>
        <br />
        <p>
          {message}
        </p>
      </main>
    </>
  )
}
